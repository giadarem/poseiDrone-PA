version: '3.8' # Versione del formato Compose.

services:
  # 1. SERVIZIO DATABASE: 'db' (PostGIS)
  db:
    image: postgis/postgis:16-3.4 # Immagine ufficiale che include PostgreSQL 16 e PostGIS 3.4.
    container_name: droni_marini_db # Nome fisso del container per un facile debug.
    restart: always # Riavvia automaticamente il container in caso di fallimento.
    environment:
      # Variabili lette dal file .env per configurare PostgreSQL.
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    ports:
      - "5432:5432" # Espone la porta del DB (5432) sulla macchina host.
    volumes:
      # Mantiene i dati del DB persistenti anche se il container viene rimosso.
      - postgres_data:/var/lib/postgresql/data 

  # 2. SERVIZIO APPLICAZIONE: 'app' (Node.js/Express)
  app:
    build: 
      context: . # Costruisce l'immagine a partire dal Dockerfile nella directory corrente.
    container_name: droni_marini_app # Nome fisso del container Express.
    restart: always
    ports:
      - "3000:3000" # Mappa la porta dell'applicazione (3000) sull'host.
    depends_on:
      - db # Garantisce che il container DB sia avviato prima di tentare di avviare il backend.
    env_file:
      - ./.env # Inietta tutte le variabili d'ambiente del file .env nel container.
    
# DEFINIZIONE DEI VOLUMI NOMINATI
volumes:
  postgres_data: # Volume nominato per la persistenza dei dati del database PostGIS.